# Flask Yoti #

Instructions for configuring your Flask project to integrate with Yoti. For details on how to run the Flask docker image, see the [Running the Examples - With Docker](https://github.com/getyoti/yoti-python-sdk/blob/master/README.md#with-docker) section in the main README.

## Plugin configuration ##
### General settings ###

* `flask_yoti` is a [Flask Blueprint](http://flask.pocoo.org/docs/0.11/blueprints/)
and all you have to do to add it to your Flask app is register it like this:
```python
# your_flask_project/app.py
from flask import Flask
from flask_yoti import flask_yoti_blueprint

app = Flask(__name__)
app.register_blueprint(flask_yoti_blueprint, url_prefix='/yoti')
```
*Don't forget to set an `app.secret_key` to be able to use `sessions`*

The variables required for the SDK to work are found in the tabs on your Yoti application's settings page ([Yoti Dashboard](https://www.yoti.com/dashboard/)). These are:

* **`YOTI_APPLICATION_ID`** - This is used to configure the [Yoti Login Button](https://www.yoti.com/developers/documentation/#2-front-end-integration).
* **`YOTI_CLIENT_SDK_ID`** - This is the SDK identifier generated by Yoti Dashboard in the Key tab when you create your app. Note this is not your Application Identifier which is needed by your client-side code.
* **`YOTI_KEY_FILE_PATH`** - This is the path to the application .pem file, we recommend keeping your .pem file outside of your repository. It can be downloaded only once from the Keys tab in your Yoti Dashboard. (e.g. /home/user/.ssh/access-security.pem).

**Please do not open the pem file** as this might corrupt the key and you will need to create a new application.

One way to configure these environment variables is to use an .env file. There are `.env.example` files supplied in the [Django](/examples/yoti_example_django/yoti_example/.env.example) and [Flask](/examples/yoti_example_flask/.env.example) example projects, which you can rename to `.env` and enter your settings into this file.

Alternatively you could define these settings in the `app.py` file like this:

```python
# your_flask_project/app.py

...

app.config.update({
    'YOTI_APPLICATION_ID': '...',
    'YOTI_CLIENT_SDK_ID': '...',
    'YOTI_KEY_FILE_PATH': '...',
    ...
})
```

### Endpoints configuration ###

`flask_yoti` plugin provides some default endpoints:
- `yoti_auth` (`/yoti/auth`) - is a callback used for receiving an
authentication token (shouldn't be changed)
- `yoti_login` (`/yoti/login`) - a view with just a login button. Can (and should)
be overridden by `'YOTI_LOGIN_VIEW'` setting
- `yoti_profile` (`/yoti/profile`) - a view with user profile details. It's
also given just for example and should be overridden by your view, using
`'YOTI_REDIRECT_TO'` setting

```python
# your_flask_project/app.py

...

app.config.update({
    ...
    'YOTI_LOGIN_VIEW': '...',
    'YOTI_REDIRECT_TO': '...',
})
```
* **`YOTI_LOGIN_VIEW`**<br>
If *not* authenticated user is trying to access a view with
`@yoti_authenticated` decorator, he/she will be redirected to this view.
Example: `login`<br>
In this case you should have something like this in your Flask app:
```python
@app.route('/login')
def login():
    render_template('login.html')
```
Default value: `flask_yoti.login` (with `/yoti/login/` URL)

* **`YOTI_REDIRECT_TO`**<br>
View name to which user is redirected after successful authentication.<br>
Example: `profile`<br>
In this case you should have something like this in your Flask app::
```python
@app.route('/profile')
@yoti_authenticated
def login():
    user_profile = session.get('yoti_user_profile')
    render_template('profile.html', **user_profile)
```
Default value: `flask_yoti.profile`  (with `/yoti/profile/` URL)

<br>


### Yoti application configuration ###

Your Yoti application's callback URL should point to `your_site.com/yoti/auth`.

## Plugin usage ##

1. First you need to add a login button to some of your view's templates.
- You can do it by using the predefined login button:
```HTML
<span data-yoti-application-id="{{app_id}}">
    Log in with Yoti
</span>
```


By clicking this button, user will be redirected to the Yoti Authentication page.

*Remember to add an appropriate script to your page with login
button in order for it to work. See: [Yoti Developers Documentation](https://www.yoti.com/developers/#login-button-setup)*

2. After successful authentication, user will be redirected to a view,
provided by the `YOTI_REDIRECT_TO` setting.
3. In order to get access to an authenticated user's information inside a view,
you should use a `@yoti_authenticated` decorator.
Example:
```python
from flask_yoti import yoti_authenticated

@yoti_authenticated
def profile_view(request):
    user_id = request.yoti_user_id
    user_profile = request.yoti_user_profile
    return render(request, 'profile.html', user_profile)
```

4. All *not authenticated* users trying to access endpoint with this decorator,
will be redirected to an endpoint, provided by the `YOTI_LOGIN_VIEW` setting.

## Tests ##

To run unit tests:
1. Change to the right directory - `cd plugins/flask_yoti`
1. Run the setup file - `python setup.py develop`
1. Run the tests - `py.test`
